{% extends "layout/app.twig" %}

{% block title %}Edytuj mieszkanie - {{ parent() }}{% endblock %}

{% block content %}
<div class="py-6">
<div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
        <!-- Page header -->
        <div class="mb-8">
            <nav class="flex mb-4" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-4">
                    <li>
                        <a href="/flats" class="text-gray-400 hover:text-gray-500">
                            <i class="fas fa-building mr-1"></i>
                            Mieszkania
                        </a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                            <a href="/flats/{{ flat.id }}" class="text-gray-400 hover:text-gray-500">{{ flat.name }}</a>
                        </div>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                            <span class="text-gray-500">Edytuj</span>
                        </div>
                    </li>
                </ol>
            </nav>
            
            <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl">
                <i class="fas fa-edit mr-2 text-primary-600"></i>
                Edytuj mieszkanie
            </h2>
            <p class="mt-1 text-sm text-gray-500">
                Modyfikuj informacje o mieszkaniu {{ flat.name }}
            </p>
        </div>

        <!-- Form -->
        <div class="bg-white shadow rounded-lg fade-in">
            <form method="POST" action="/flats/{{ flat.id }}/update" class="space-y-6 p-6">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                
                <!-- Basic information -->
                <div>
                    <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">
                        <i class="fas fa-info-circle mr-2 text-primary-600"></i>
                        Podstawowe informacje
                    </h3>
                    
                    <div class="grid grid-cols-1 gap-6">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">
                                Nazwa mieszkania *
                            </label>
                            <div class="mt-1">
                                <input type="text" name="name" id="name" required value="{{ flat.name }}"
                                       class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 rounded-md"
                                       placeholder="np. Mieszkanie 1, Apartament A, itp.">
                            </div>
                        </div>


                    </div>
                </div>

                <!-- Utilities -->
                <div>
                    <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">
                        <i class="fas fa-cogs mr-2 text-primary-600"></i>
                        Liczniki mediÃ³w
                    </h3>
                    <p class="text-sm text-gray-500 mb-4">
                        Edytuj liczniki mediÃ³w dla tego mieszkania. MoÅ¼esz dodaÄ‡ wiele licznikÃ³w tego samego typu.
                    </p>
                    
                    <div id="utilities-container">
                        {% if flat.utilities is empty %}
                            <!-- DomyÅ›lny licznik jeÅ›li brak -->
                            <div class="utility-item bg-gray-50 rounded-lg p-4 mb-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="font-medium text-gray-900">Licznik #1</h4>
                                    <button type="button" onclick="removeUtility(this)" class="text-red-600 hover:text-red-800 hidden">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Typ medium *</label>
                                        <select name="utilities[0][type]" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500" onchange="updateRatePlaceholder(this)">
                                            <option value="">Wybierz typ</option>
                                            <option value="gas" data-default-rate="2.45">ðŸ”¥ Gaz</option>
                                            <option value="electricity" data-default-rate="0.65">âš¡ PrÄ…d</option>
                                            <option value="cold_water" data-default-rate="4.20">ðŸ’§ Woda zimna</option>
                                            <option value="hot_water" data-default-rate="18.50">ðŸ”´ Woda ciepÅ‚a</option>
            
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nazwa/Opis</label>
                                        <input type="text" name="utilities[0][name]" placeholder="np. Kuchnia, Åazienka, GÅ‚Ã³wny..."
                                               class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                        <p class="text-xs text-gray-500 mt-1">Opcjonalnie - pomaga rozrÃ³Å¼niÄ‡ liczniki</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Stan poczÄ…tkowy</label>
                                        <input type="number" name="utilities[0][initial_reading]" step="0.001" min="0" value="0.00" placeholder="0.00"
                                               class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                        <p class="text-xs text-gray-500 mt-1">Odczyt poczÄ…tkowy licznika</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">OpÅ‚ata staÅ‚a/przesyÅ‚owa</label>
                                        <input type="number" name="utilities[0][fixed_cost]" step="0.001" min="0" value="0.00" placeholder="0.00"
                                               class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                        <p class="text-xs text-gray-500 mt-1">Abonament, opÅ‚ata przesyÅ‚owa itp.</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Stawka (zÅ‚/jednostka)</label>
                                        <input type="number" name="utilities[0][rate]" step="0.001" min="0" placeholder="DomyÅ›lna"
                                               class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                        <p class="text-xs text-gray-500 mt-1">Pozostaw puste dla domyÅ›lnej stawki</p>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            {% for utilityId, utility in flat.utilities %}
                                <div class="utility-item bg-gray-50 rounded-lg p-4 mb-4">
                                    <div class="flex items-center justify-between mb-3">
                                        <h4 class="font-medium text-gray-900">Licznik</h4>
                                        <button type="button" onclick="removeUtility(this)" class="text-red-600 hover:text-red-800 {% if flat.utilities|length == 1 %}hidden{% endif %}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Typ medium *</label>
                                            <select name="utilities[{{ loop.index0 }}][type]" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500" onchange="updateRatePlaceholder(this)">
                                                <option value="">Wybierz typ</option>
                                                <option value="gas" data-default-rate="2.45" {% if utility.type == 'gas' %}selected{% endif %}>ðŸ”¥ Gaz</option>
                                                <option value="electricity" data-default-rate="0.65" {% if utility.type == 'electricity' %}selected{% endif %}>âš¡ PrÄ…d</option>
                                                <option value="cold_water" data-default-rate="4.20" {% if utility.type == 'cold_water' %}selected{% endif %}>ðŸ’§ Woda zimna</option>
                                                <option value="hot_water" data-default-rate="18.50" {% if utility.type == 'hot_water' %}selected{% endif %}>ðŸ”´ Woda ciepÅ‚a</option>
                
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Nazwa/Opis</label>
                                            <input type="text" name="utilities[{{ loop.index0 }}][name]" value="{{ utility.name ?? '' }}" placeholder="np. Kuchnia, Åazienka, GÅ‚Ã³wny..."
                                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                            <input type="hidden" name="utilities[{{ loop.index0 }}][id]" value="{{ utility.id }}">
                                            <p class="text-xs text-gray-500 mt-1">Opcjonalnie - pomaga rozrÃ³Å¼niÄ‡ liczniki</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Stan poczÄ…tkowy</label>
                                            <input type="number" name="utilities[{{ loop.index0 }}][initial_reading]" value="{{ utility.initial_reading ?? '0.00' }}" step="0.001" min="0" placeholder="0.00"
                                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                            <p class="text-xs text-gray-500 mt-1">Odczyt poczÄ…tkowy licznika</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">OpÅ‚ata staÅ‚a/przesyÅ‚owa</label>
                                            <input type="number" name="utilities[{{ loop.index0 }}][fixed_cost]" value="{{ utility.fixed_cost ?? '0.00' }}" step="0.001" min="0" placeholder="0.00"
                                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                            <p class="text-xs text-gray-500 mt-1">Abonament, opÅ‚ata przesyÅ‚owa itp.</p>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1">Stawka (zÅ‚/jednostka)</label>
                                            <input type="number" name="utilities[{{ loop.index0 }}][rate]" value="{{ utility.rate ?? '' }}" step="0.001" min="0" placeholder="{% if utility.type == 'gas' %}DomyÅ›lna: 2.45 zÅ‚{% elseif utility.type == 'electricity' %}DomyÅ›lna: 0.65 zÅ‚{% elseif utility.type == 'cold_water' %}DomyÅ›lna: 4.20 zÅ‚{% elseif utility.type == 'hot_water' %}DomyÅ›lna: 18.50 zÅ‚{% else %}DomyÅ›lna{% endif %}"
                                                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                            <p class="text-xs text-gray-500 mt-1">Pozostaw puste dla domyÅ›lnej stawki</p>
                                        </div>
                                        <div>
                                            <div class="flex items-center mb-2">
                                                <input type="checkbox" name="utilities[{{ loop.index0 }}][fixed_amount_enabled]" id="fixed_amount_{{ loop.index0 }}" value="1" 
                                                       {% if utility.fixed_amount_enabled ?? false %}checked{% endif %}
                                                       class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                                                       onchange="toggleFixedAmount(this)">
                                                <label for="fixed_amount_{{ loop.index0 }}" class="ml-2 block text-sm font-medium text-gray-700">
                                                    WartoÅ›Ä‡ staÅ‚a
                                                </label>
                                            </div>
                                            <div id="fixed_amount_field_{{ loop.index0 }}" class="{% if not (utility.fixed_amount_enabled ?? false) %}hidden{% endif %}">
                                                <input type="number" name="utilities[{{ loop.index0 }}][fixed_amount]" value="{{ utility.fixed_amount ?? '0.00' }}" step="0.01" min="0" placeholder="0.00"
                                                       class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                                                <p class="text-xs text-gray-500 mt-1">Podaj wartoÅ›Ä‡ staÅ‚Ä… (zÅ‚)</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <button type="button" onclick="addUtility()" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-plus mr-2"></i>
                        Dodaj kolejny licznik
                    </button>
                </div>

                <!-- Warning about changing utilities -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-yellow-800">
                                Uwaga przy zmianie mediÃ³w
                            </h3>
                            <div class="mt-2 text-sm text-yellow-700">
                                <p>
                                    Zmiana listy mediÃ³w wpÅ‚ynie tylko na nowe rozliczenia. 
                                    IstniejÄ…ce rozliczenia nie zostanÄ… zmodyfikowane.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
                    <a href="/flats/{{ flat.id }}" 
                       class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                        <i class="fas fa-times mr-2"></i>
                        Anuluj
                    </a>
                    <button type="submit" 
                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                        <i class="fas fa-save mr-2"></i>
                        Zapisz zmiany
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let utilityCounter = {{ flat.utilities|length > 0 ? flat.utilities|length : 1 }};

function addUtility() {
    const container = document.getElementById('utilities-container');
    const newUtility = document.createElement('div');
    newUtility.className = 'utility-item bg-gray-50 rounded-lg p-4 mb-4';
    newUtility.innerHTML = `
        <div class="flex items-center justify-between mb-3">
            <h4 class="font-medium text-gray-900">Licznik #${utilityCounter + 1}</h4>
            <button type="button" onclick="removeUtility(this)" class="text-red-600 hover:text-red-800">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Typ medium *</label>
                <select name="utilities[${utilityCounter}][type]" required class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500" onchange="updateRatePlaceholder(this)">
                    <option value="">Wybierz typ</option>
                    <option value="gas" data-default-rate="2.45">ðŸ”¥ Gaz</option>
                    <option value="electricity" data-default-rate="0.65">âš¡ PrÄ…d</option>
                    <option value="cold_water" data-default-rate="4.20">ðŸ’§ Woda zimna</option>
                    <option value="hot_water" data-default-rate="18.50">ðŸ”´ Woda ciepÅ‚a</option>

                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nazwa/Opis</label>
                <input type="text" name="utilities[${utilityCounter}][name]" placeholder="np. Kuchnia, Åazienka, GÅ‚Ã³wny..."
                       class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                <p class="text-xs text-gray-500 mt-1">Opcjonalnie - pomaga rozrÃ³Å¼niÄ‡ liczniki</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Stan poczÄ…tkowy</label>
                <input type="number" name="utilities[${utilityCounter}][initial_reading]" step="0.001" min="0" value="0.00" placeholder="0.00"
                       class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                <p class="text-xs text-gray-500 mt-1">Odczyt poczÄ…tkowy licznika</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">OpÅ‚ata staÅ‚a/przesyÅ‚owa</label>
                <input type="number" name="utilities[${utilityCounter}][fixed_cost]" step="0.001" min="0" value="0.00" placeholder="0.00"
                       class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                <p class="text-xs text-gray-500 mt-1">Abonament, opÅ‚ata przesyÅ‚owa itp.</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Stawka (zÅ‚/jednostka)</label>
                <input type="number" name="utilities[${utilityCounter}][rate]" step="0.001" min="0" placeholder="DomyÅ›lna"
                       class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                <p class="text-xs text-gray-500 mt-1">Pozostaw puste dla domyÅ›lnej stawki</p>
            </div>
            <div>
                <div class="flex items-center mb-2">
                    <input type="checkbox" name="utilities[${utilityCounter}][fixed_amount_enabled]" id="fixed_amount_${utilityCounter}" value="1" 
                           class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                           onchange="toggleFixedAmount(this)">
                    <label for="fixed_amount_${utilityCounter}" class="ml-2 block text-sm font-medium text-gray-700">
                        WartoÅ›Ä‡ staÅ‚a
                    </label>
                </div>
                <div id="fixed_amount_field_${utilityCounter}" class="hidden">
                    <input type="number" name="utilities[${utilityCounter}][fixed_amount]" step="0.01" min="0" value="0.00" placeholder="0.00"
                           class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500">
                    <p class="text-xs text-gray-500 mt-1">Podaj wartoÅ›Ä‡ staÅ‚Ä… (zÅ‚)</p>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(newUtility);
    utilityCounter++;
    
    updateRemoveButtons();
}

function removeUtility(button) {
    const utilityItem = button.closest('.utility-item');
    utilityItem.remove();
    updateRemoveButtons();
    renumberUtilities();
}

function updateRemoveButtons() {
    const utilities = document.querySelectorAll('.utility-item');
    utilities.forEach((utility, index) => {
        const removeButton = utility.querySelector('button[onclick*="removeUtility"]');
        if (utilities.length > 1) {
            removeButton.classList.remove('hidden');
        } else {
            removeButton.classList.add('hidden');
        }
    });
}

function renumberUtilities() {
    const utilities = document.querySelectorAll('.utility-item');
    utilities.forEach((utility, index) => {
        const title = utility.querySelector('h4');
        title.textContent = `Licznik #${index + 1}`;
        
        // Zaktualizuj nazwy pÃ³l
        const typeSelect = utility.querySelector('select');
        const nameInput = utility.querySelector('input[type="text"]');
        const initialReadingInput = utility.querySelector('input[name*="[initial_reading]"]');
        const fixedCostInput = utility.querySelector('input[name*="[fixed_cost]"]');
        const rateInput = utility.querySelector('input[name*="[rate]"]');
        const hiddenInput = utility.querySelector('input[type="hidden"]');
        const fixedAmountCheckbox = utility.querySelector('input[name*="[fixed_amount_enabled]"]');
        const fixedAmountInput = utility.querySelector('input[name*="[fixed_amount]"]');
        
        typeSelect.name = `utilities[${index}][type]`;
        nameInput.name = `utilities[${index}][name]`;
        initialReadingInput.name = `utilities[${index}][initial_reading]`;
        fixedCostInput.name = `utilities[${index}][fixed_cost]`;
        rateInput.name = `utilities[${index}][rate]`;
        if (hiddenInput) {
            hiddenInput.name = `utilities[${index}][id]`;
        }
        if (fixedAmountCheckbox) {
            fixedAmountCheckbox.name = `utilities[${index}][fixed_amount_enabled]`;
            fixedAmountCheckbox.id = `fixed_amount_${index}`;
        }
        if (fixedAmountInput) {
            fixedAmountInput.name = `utilities[${index}][fixed_amount]`;
        }
        
        // Zaktualizuj ID pola fixed_amount_field
        const fixedAmountField = utility.querySelector('div[id^="fixed_amount_field_"]');
        if (fixedAmountField) {
            fixedAmountField.id = `fixed_amount_field_${index}`;
        }
    });
    
    utilityCounter = utilities.length;
}

function updateRatePlaceholder(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const defaultRate = selectedOption.getAttribute('data-default-rate');
    const utilityItem = selectElement.closest('.utility-item');
    const rateInput = utilityItem.querySelector('input[type="number"]');
    
    if (defaultRate && rateInput) {
        rateInput.placeholder = `DomyÅ›lna: ${defaultRate} zÅ‚`;
    } else if (rateInput) {
        rateInput.placeholder = 'DomyÅ›lna';
    }
}

function toggleFixedAmount(checkbox) {
    const utilityItem = checkbox.closest('.utility-item');
    const fieldId = checkbox.id.replace('fixed_amount_', 'fixed_amount_field_');
    const field = document.getElementById(fieldId);
    
    if (checkbox.checked) {
        field.classList.remove('hidden');
    } else {
        field.classList.add('hidden');
        // WyczyÅ›Ä‡ pole gdy checkbox jest odznaczony
        const input = field.querySelector('input[type="number"]');
        if (input) {
            input.value = '0.00';
        }
    }
}

// Inicjalizacja przy Å‚adowaniu strony
document.addEventListener('DOMContentLoaded', function() {
    updateRemoveButtons();
    
    // Ustaw placeholder dla istniejÄ…cych pÃ³l stawki
    document.querySelectorAll('select[name*="[type]"]').forEach(select => {
        updateRatePlaceholder(select);
    });
});
</script>
{% endblock %}
