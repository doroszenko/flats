{% extends "layout/app.twig" %}

{% block title %}Historia rozliczeń - {{ flat.name }} - {{ parent() }}{% endblock %}

{% block content %}
<div class="py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 md:px-8">
        <!-- Page header -->
        <div class="mb-8">
            <nav class="flex mb-4" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-4">
                    <li>
                        <a href="/flats" class="text-gray-400 hover:text-gray-500">
                            <i class="fas fa-building mr-1"></i>
                            Mieszkania
                        </a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                            <a href="/flats/{{ flat.id }}" class="text-gray-400 hover:text-gray-500">{{ flat.name }}</a>
                        </div>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                            <span class="text-gray-500">Historia i wykresy</span>
                        </div>
                    </li>
                </ol>
            </nav>
            
            <div class="md:flex md:items-center md:justify-between">
                <div class="flex-1 min-w-0">
                    <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                        <i class="fas fa-chart-line mr-2 text-primary-600"></i>
                        Historia rozliczeń - {{ flat.name }}
                    </h2>
                </div>
                <div class="mt-4 flex space-x-3 md:mt-0 md:ml-4">
                    <a href="/flats/{{ flat.id }}/bills" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                        <i class="fas fa-file-invoice mr-2"></i>
                        Rozliczenia
                    </a>
                </div>
            </div>
        </div>

        {% if history is empty %}
            <!-- Empty state -->
            <div class="text-center py-12 bg-white rounded-lg shadow">
                <i class="fas fa-chart-line text-gray-300 text-6xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Brak historii rozliczeń</h3>
                <p class="text-gray-500 mb-6">Historia będzie dostępna po zatwierdzeniu pierwszego rozliczenia</p>
                <a href="/flats/{{ flat.id }}/bills" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-primary-600 bg-primary-100 hover:bg-primary-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-colors duration-200">
                    <i class="fas fa-file-invoice mr-2"></i>
                    Zobacz rozliczenia
                </a>
            </div>
        {% else %}
            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <!-- Cost trend chart -->
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow fade-in">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">
                        <i class="fas fa-chart-line mr-2 text-primary-600"></i>
                        Trend kosztów w czasie
                    </h3>
                    <div class="relative" style="height: 300px;">
                        <canvas id="costTrendChart"></canvas>
                    </div>
                </div>

                <!-- Utility comparison chart -->
                <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow fade-in">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">
                        <i class="fas fa-chart-bar mr-2 text-primary-600"></i>
                        Porównanie mediów (Lipiec 2025)
                    </h3>
                    <div class="relative" style="height: 300px;">
                        <canvas id="utilityComparisonChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- History table -->
            <div class="bg-white shadow overflow-hidden sm:rounded-lg fade-in">
                <div class="px-4 py-5 sm:px-6">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">
                        <i class="fas fa-history mr-2 text-primary-600"></i>
                        Historia rozliczeń
                    </h3>
                </div>
                <div class="border-t border-gray-200">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Okres
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Media
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Łączny koszt
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Data zatwierdzenia
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for bill in history %}
                                    <tr class="hover:bg-gray-50 transition-colors duration-200">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900">{{ bill.period }}</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex flex-wrap gap-1">
                                                {% for utilityId, cost in bill.costs %}
                                                    {% set utility = flat.utilities[utilityId] %}
                                                    {% set fixedCost = bill.fixed_costs[utilityId] ?? 0 %}
                                                    {% set totalUtilityCost = cost + fixedCost %}
                                                    {% set isFixedAmount = utility.fixed_amount_enabled ?? false %}
                                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium {% if isFixedAmount %}bg-blue-100 text-blue-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                                                        {% if utility %}
                                                            {% if utility.type == 'gas' %}
                                                                <i class="fas fa-fire mr-1 text-orange-500"></i>Gaz
                                                            {% elseif utility.type == 'electricity' %}
                                                                <i class="fas fa-bolt mr-1 text-yellow-500"></i>Prąd
                                                            {% elseif utility.type == 'cold_water' %}
                                                                <i class="fas fa-tint mr-1 text-blue-500"></i>Woda zimna
                                                            {% elseif utility.type == 'hot_water' %}
                                                                <i class="fas fa-tint mr-1 text-red-500"></i>Woda ciepła
                                                            {% else %}
                                                                {{ utility.type|title }}
                                                            {% endif %}
                                                            {% if utility.name %}
                                                                ({{ utility.name }})
                                                            {% else %}
                                                                (Licznik #{{ utilityId|slice(0, 8) }})
                                                            {% endif %}
                                                        {% else %}
                                                            <i class="fas fa-exclamation-triangle mr-1 text-red-500"></i>
                                                            Usunięty licznik ({{ utilityId|slice(0, 8) }})
                                                        {% endif %}
                                                        : {{ totalUtilityCost|number_format(2, ',', ' ') }} zł
                                                        {% if utility and isFixedAmount %}
                                                            <span class="text-blue-600 font-medium"> (wartość stała)</span>
                                                        {% elseif fixedCost > 0 %}
                                                            <span class="text-gray-500"> ({{ cost|number_format(2, ',', ' ') }}+{{ fixedCost|number_format(2, ',', ' ') }})</span>
                                                        {% endif %}
                                                    </span>
                                                {% endfor %}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-semibold text-gray-900">
                                                {{ bill.total_cost|number_format(2, ',', ' ') }} zł
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {{ bill.confirmed_at|date('d.m.Y H:i') }}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

{% if history is not empty %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Pobierz dane z API
    fetch('/api/flats/{{ flat.id }}/chart-data')
        .then(response => response.json())
        .then(data => {
            createCostTrendChart(data);
            createUtilityComparisonChart(data);
        })
        .catch(error => {
            console.error('Błąd podczas ładowania danych wykresów:', error);
        });
});

function createCostTrendChart(data) {
    const ctx = document.getElementById('costTrendChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: false
                },
                legend: {
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('pl-PL', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }) + ' zł';
                        }
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            elements: {
                point: {
                    radius: 4,
                    hoverRadius: 6
                }
            }
        }
    });
}

function createUtilityComparisonChart(data) {
    if (!data.datasets || data.datasets.length === 0) return;
    
    const ctx = document.getElementById('utilityComparisonChart').getContext('2d');
    
    // Pobierz dane z ostatniego miesiąca
    const lastMonthData = data.datasets.map(dataset => ({
        label: dataset.label,
        data: dataset.data[dataset.data.length - 1] || 0,
        backgroundColor: dataset.borderColor + '80', // Dodaj przezroczystość
        borderColor: dataset.borderColor,
        borderWidth: 2
    }));
    
    // Grupuj dane według typu mediów i sumuj
    const groupedData = {};
    const groupedColors = {};
    
    lastMonthData.forEach(item => {
        // Wyciągnij typ medium z etykiety (np. "Gaz (Licznik 1)" -> "Gaz")
        // Usuń oznaczenie "(wartość stała)" jeśli istnieje
        let utilityType = item.label.split(' (')[0];
        
        // Sprawdź czy to licznik z wartością stałą
        const isFixedAmount = item.label.includes('(wartość stała)');
        
        if (!groupedData[utilityType]) {
            groupedData[utilityType] = 0;
            groupedColors[utilityType] = item.backgroundColor;
        }
        groupedData[utilityType] += item.data;
    });
    
    const labels = Object.keys(groupedData);
    const values = Object.values(groupedData);
    const colors = Object.values(groupedColors);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors,
                borderColor: colors.map(color => color.replace('80', '')),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed.y;
                            return context.label + ': ' + value.toLocaleString('pl-PL', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }) + ' zł';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('pl-PL', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }) + ' zł';
                        }
                    }
                }
            }
        }
    });
}
</script>
{% endif %}
{% endblock %}
